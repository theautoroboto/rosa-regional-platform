# CI build-root image for rosa-regional-platform PR checks.
# Used by ci-operator via build_root.project_image.dockerfile_path.
# Tools are layer-cached â€” installs only re-run when this file changes.

FROM registry.access.redhat.com/ubi10/ubi:latest

ARG TERRAFORM_VERSION=1.14.3
ARG HELM_VERSION=v3.16.0
ARG UV_VERSION=0.6.0
ARG AWS_CLI_VERSION=2.33.19

# System packages
RUN dnf install -y \
        git \
        make \
        jq \
        unzip \
        python3-pip \
        findutils \
        gnupg2 \
        openssl \
    && dnf clean all

# Terraform (GPG-verified)
RUN arch=$(uname -m) && \
    case "${arch}" in \
        x86_64)  arch="amd64" ;; \
        aarch64) arch="arm64" ;; \
    esac && \
    TF_PACKAGE="terraform_${TERRAFORM_VERSION}_linux_${arch}.zip" && \
    TF_BASE_URL="https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}" && \
    curl -fsSLO "${TF_BASE_URL}/${TF_PACKAGE}" && \
    curl -fsSLO "${TF_BASE_URL}/terraform_${TERRAFORM_VERSION}_SHA256SUMS" && \
    curl -fsSLO "${TF_BASE_URL}/terraform_${TERRAFORM_VERSION}_SHA256SUMS.sig" && \
    ( gpg --batch --keyserver keyserver.ubuntu.com --recv-keys \
        C874011F0AB405110D02105534365D9472D7468F || \
      gpg --batch --keyserver keys.openpgp.org --recv-keys \
        C874011F0AB405110D02105534365D9472D7468F || \
      gpg --batch --keyserver pgp.mit.edu --recv-keys \
        C874011F0AB405110D02105534365D9472D7468F ) && \
    gpg --batch --verify "terraform_${TERRAFORM_VERSION}_SHA256SUMS.sig" \
        "terraform_${TERRAFORM_VERSION}_SHA256SUMS" && \
    grep "${TF_PACKAGE}" "terraform_${TERRAFORM_VERSION}_SHA256SUMS" | sha256sum -c - && \
    unzip -qo "${TF_PACKAGE}" -d /usr/local/bin && \
    chmod +x /usr/local/bin/terraform && \
    rm -f "${TF_PACKAGE}" "terraform_${TERRAFORM_VERSION}_SHA256SUMS" \
        "terraform_${TERRAFORM_VERSION}_SHA256SUMS.sig"

# Helm 3 (pinned release tag; get-helm-3 verifies checksums by default)
RUN curl -fsSL "https://raw.githubusercontent.com/helm/helm/${HELM_VERSION}/scripts/get-helm-3" \
    | DESIRED_VERSION="${HELM_VERSION}" VERIFY_CHECKSUM=true bash

# uv (Python package manager - pinned version, installer verifies binary checksum)
RUN curl -fsSL "https://astral.sh/uv/${UV_VERSION}/install.sh" -o /tmp/uv-install.sh && \
    UV_UNMANAGED_INSTALL=/usr/local/bin sh /tmp/uv-install.sh && \
    rm /tmp/uv-install.sh && \
    uv --version

# AWS CLI v2
RUN arch=$(uname -m) && \
    case "${arch}" in \
        x86_64)  AWS_ARCH="x86_64" ;; \
        aarch64) AWS_ARCH="aarch64" ;; \
    esac && \
    curl -fsSL "https://awscli.amazonaws.com/awscli-exe-linux-${AWS_ARCH}-${AWS_CLI_VERSION}.zip" -o "awscliv2.zip" && \
    unzip -qo awscliv2.zip && \
    ./aws/install && \
    rm -rf awscliv2.zip ./aws && \
    aws --version

# Pre-create cache directories writable by any UID (OpenShift runs as random UID)
RUN mkdir -p /tmp/.uv-cache /tmp/.uv-python /tmp/.terraform.d && \
    chmod -R 777 /tmp/.uv-cache /tmp/.uv-python /tmp/.terraform.d

ENV UV_CACHE_DIR=/tmp/.uv-cache
ENV UV_PYTHON_INSTALL_DIR=/tmp/.uv-python
ENV UV_NO_PROGRESS=true

# Python packages (awscurl for API Gateway testing)
# RUN uv pip install --system awscurl
