apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "hyperfleet-adapter.fullname" . }}
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "hyperfleet-adapter.labels" . | nindent 4 }}
spec:
  replicas: {{ .Values.hyperfleetAdapter.replicaCount }}
  selector:
    matchLabels:
      {{- include "hyperfleet-adapter.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      annotations:
        {{- if .Values.hyperfleetAdapter.adapterConfig.create }}
        checksum/config: {{ include (print $.Template.BasePath "/adapter-configmap-adapter.yaml") . | sha256sum }}
        {{- end }}
        {{- if .Values.hyperfleetAdapter.adapterTaskConfig.create }}
        checksum/task-config: {{ include (print $.Template.BasePath "/adapter-configmap-adapter-task.yaml") . | sha256sum }}
        {{- end }}
      labels:
        {{- include "hyperfleet-adapter.selectorLabels" . | nindent 8 }}
    spec:
      serviceAccountName: {{ include "hyperfleet-adapter.serviceAccountName" . }}
      securityContext:
        {{- toYaml .Values.hyperfleetAdapter.podSecurityContext | nindent 8 }}
      containers:
        - name: {{ .Chart.Name }}
          securityContext:
            {{- toYaml .Values.hyperfleetAdapter.securityContext | nindent 12 }}
          image: "{{ .Values.hyperfleetAdapter.image.registry }}/{{ .Values.hyperfleetAdapter.image.repository }}:{{ .Values.hyperfleetAdapter.image.tag }}"
          imagePullPolicy: {{ .Values.hyperfleetAdapter.image.pullPolicy }}
          command:
            - /app/adapter
          args:
            - serve
            - --config
            - /etc/adapter/adapter-config.yaml
            - --task-config
            - /etc/adapter/task-config.yaml
          {{- with .Values.hyperfleetAdapter.containerPorts }}
          ports:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          env:
            - name: LOG_LEVEL
              value: {{ .Values.hyperfleetAdapter.adapterConfig.log.level }}
            - name: HYPERFLEET_API_BASE_URL
              value: {{ .Values.hyperfleetAdapter.adapterConfig.hyperfleetApi.baseUrl | quote }}
            - name: HYPERFLEET_API_VERSION
              value: {{ .Values.hyperfleetAdapter.adapterConfig.hyperfleetApi.version | quote }}
            - name: BROKER_CONFIG_FILE
              value: /etc/broker/broker.yaml
            {{- if eq .Values.hyperfleetAdapter.broker.type "rabbitmq" }}
            {{- if .Values.hyperfleetAdapter.broker.external.enabled }}
            # Broker URL from Kubernetes Secret (created by SecretProviderClass)
            - name: BROKER_RABBITMQ_URL
              valueFrom:
                secretKeyRef:
                  name: {{ include "hyperfleet-adapter.fullname" . }}-mq-secret
                  key: BROKER_RABBITMQ_URL
            {{- else }}
            - name: BROKER_RABBITMQ_URL
              value: {{ .Values.hyperfleetAdapter.broker.rabbitmq.url | quote }}
            {{- end }}
            - name: BROKER_QUEUE
              value: {{ .Values.hyperfleetAdapter.broker.rabbitmq.queue | quote }}
            {{- end }}
            {{- if .Values.hyperfleetAdapter.adapterConfig.maestro.enabled }}
            - name: HYPERFLEET_MAESTRO_GRPC_SERVER_ADDRESS
              value: {{ .Values.hyperfleetAdapter.adapterConfig.maestro.grpcServerAddress | quote }}
            - name: HYPERFLEET_MAESTRO_HTTP_SERVER_ADDRESS
              value: {{ .Values.hyperfleetAdapter.adapterConfig.maestro.httpServerAddress | quote }}
            - name: HYPERFLEET_MAESTRO_SOURCE_ID
              value: {{ .Values.hyperfleetAdapter.adapterConfig.maestro.sourceId | quote }}
            - name: HYPERFLEET_MAESTRO_CLIENT_ID
              value: {{ .Values.hyperfleetAdapter.adapterConfig.maestro.clientId | quote }}
            - name: HYPERFLEET_MAESTRO_TIMEOUT
              value: {{ .Values.hyperfleetAdapter.adapterConfig.maestro.timeout | quote }}
            - name: HYPERFLEET_MAESTRO_RETRY_ATTEMPTS
              value: {{ .Values.hyperfleetAdapter.adapterConfig.maestro.retryAttempts | quote }}
            {{- if .Values.hyperfleetAdapter.adapterConfig.maestro.insecure }}
            - name: HYPERFLEET_MAESTRO_INSECURE
              value: "true"
            {{- end }}
            {{- if eq .Values.hyperfleetAdapter.adapterConfig.maestro.auth.type "tls" }}
            - name: HYPERFLEET_MAESTRO_CA_FILE
              value: {{ .Values.hyperfleetAdapter.adapterConfig.maestro.auth.tlsConfig.caFile | quote }}
            - name: HYPERFLEET_MAESTRO_CERT_FILE
              value: {{ .Values.hyperfleetAdapter.adapterConfig.maestro.auth.tlsConfig.certFile | quote }}
            - name: HYPERFLEET_MAESTRO_KEY_FILE
              value: {{ .Values.hyperfleetAdapter.adapterConfig.maestro.auth.tlsConfig.keyFile | quote }}
            {{- end }}
            {{- end }}
          {{- if .Values.hyperfleetAdapter.probes.liveness.enabled }}
          livenessProbe:
            httpGet:
              path: {{ .Values.hyperfleetAdapter.probes.liveness.path }}
              port: {{ .Values.hyperfleetAdapter.probes.liveness.port }}
            initialDelaySeconds: {{ .Values.hyperfleetAdapter.probes.liveness.initialDelaySeconds }}
            periodSeconds: {{ .Values.hyperfleetAdapter.probes.liveness.periodSeconds }}
            timeoutSeconds: {{ .Values.hyperfleetAdapter.probes.liveness.timeoutSeconds }}
            failureThreshold: {{ .Values.hyperfleetAdapter.probes.liveness.failureThreshold }}
          {{- end }}
          {{- if .Values.hyperfleetAdapter.probes.readiness.enabled }}
          readinessProbe:
            httpGet:
              path: {{ .Values.hyperfleetAdapter.probes.readiness.path }}
              port: {{ .Values.hyperfleetAdapter.probes.readiness.port }}
            initialDelaySeconds: {{ .Values.hyperfleetAdapter.probes.readiness.initialDelaySeconds }}
            periodSeconds: {{ .Values.hyperfleetAdapter.probes.readiness.periodSeconds }}
            timeoutSeconds: {{ .Values.hyperfleetAdapter.probes.readiness.timeoutSeconds }}
            failureThreshold: {{ .Values.hyperfleetAdapter.probes.readiness.failureThreshold }}
          {{- end }}
          resources:
            {{- toYaml .Values.hyperfleetAdapter.resources | nindent 12 }}
          volumeMounts:
            - name: adapter-config
              mountPath: /etc/adapter
              readOnly: true
            - name: broker-config
              mountPath: /etc/broker/broker.yaml
              subPath: broker.yaml
              readOnly: true
            {{- if .Values.hyperfleetAdapter.broker.external.enabled }}
            - name: mq-secrets
              mountPath: {{ .Values.hyperfleetAdapter.broker.external.secretMountPath }}
              readOnly: true
            {{- end }}
            - name: tmp
              mountPath: /tmp
      volumes:
        - name: adapter-config
          projected:
            sources:
              {{- if .Values.hyperfleetAdapter.adapterConfig.create }}
              - configMap:
                  name: {{ include "hyperfleet-adapter.adapterConfigMapName" . }}
                  items:
                    - key: adapter-config.yaml
                      path: adapter-config.yaml
              {{- end }}
              {{- if .Values.hyperfleetAdapter.adapterTaskConfig.create }}
              - configMap:
                  name: {{ include "hyperfleet-adapter.adapterTaskConfigMapName" . }}
                  items:
                    - key: task-config.yaml
                      path: task-config.yaml
              {{- end }}
        - name: broker-config
          configMap:
            name: {{ include "hyperfleet-adapter.brokerConfigMapName" . }}
        {{- if .Values.hyperfleetAdapter.broker.external.enabled }}
        - name: mq-secrets
          csi:
            driver: secrets-store.csi.k8s.io
            readOnly: true
            volumeAttributes:
              secretProviderClass: {{ include "hyperfleet-adapter.fullname" . }}-mq-secrets
        {{- end }}
        - name: tmp
          emptyDir: {}
      {{- with .Values.hyperfleetAdapter.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.hyperfleetAdapter.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.hyperfleetAdapter.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
