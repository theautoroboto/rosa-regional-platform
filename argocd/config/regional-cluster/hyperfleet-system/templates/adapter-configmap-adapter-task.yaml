{{- if .Values.hyperfleetAdapter.adapterTaskConfig.create }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "hyperfleet-adapter.adapterTaskConfigMapName" . }}
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "hyperfleet-adapter.labels" . | nindent 4 }}
    app.kubernetes.io/component: adapter-task-config
data:
  task-config.yaml: |
    apiVersion: hyperfleet.redhat.com/v1alpha1
    kind: AdapterTaskConfig
    metadata:
      name: landing-zone
      labels:
        hyperfleet.io/adapter-type: landing-zone
        hyperfleet.io/component: adapter
    spec:
      # Parameters with all required variables
      params:
        - name: "hyperfleetApiBaseUrl"
          source: "env.HYPERFLEET_API_BASE_URL"
          type: "string"
          required: true

        - name: "hyperfleetApiVersion"
          source: "env.HYPERFLEET_API_VERSION"
          type: "string"
          default: "v1"

        - name: "clusterId"
          source: "event.id"
          type: "string"
          required: true

        - name: "generation"
          source: "event.generation"
          type: "int"
          required: true

      # Preconditions
      preconditions:
        - name: "clusterStatus"
          apiCall:
            method: "GET"
            url: "/clusters/{{ "{{" }} .clusterId {{ "}}" }}"
            timeout: 10s
            retryAttempts: 3
            retryBackoff: "exponential"
          capture:
            - name: "clusterName"
              field: "name"
            - name: "generationSpec"
              field: "generation"

      # Resources to create
      resources:
        - name: "clusterNamespace"
          manifest:
            apiVersion: v1
            kind: Namespace
            metadata:
              name: "{{ "{{" }} .clusterId {{ "}}" }}"
              labels:
                hyperfleet.io/cluster-id: "{{ "{{" }} .clusterId {{ "}}" }}"
                hyperfleet.io/cluster-name: "{{ "{{" }} .clusterName {{ "}}" }}"
              annotations:
                hyperfleet.io/generation: "{{ "{{" }} .generationSpec {{ "}}" }}"
          discovery:
            namespace: "*"  # Cluster-scoped resource (Namespace)
            bySelectors:
              labelSelector:
                hyperfleet.io/cluster-id: "{{ "{{" }} .clusterId {{ "}}" }}"

        - name: "clusterServiceAccount"
          manifest:
            apiVersion: v1
            kind: ServiceAccount
            metadata:
              name: "{{ "{{" }} .clusterId {{ "}}" }}-sa"
              namespace: "{{ "{{" }} .clusterId {{ "}}" }}"
              labels:
                hyperfleet.io/cluster-id: "{{ "{{" }} .clusterId {{ "}}" }}"
          discovery:
            namespace: "{{ "{{" }} .clusterId {{ "}}" }}"
            bySelectors:
              labelSelector:
                hyperfleet.io/cluster-id: "{{ "{{" }} .clusterId {{ "}}" }}"
{{- end }}
