# Consolidated values for HyperFleet System
# This chart deploys API, Sentinel, and Adapter into hyperfleet-system namespace

# Global namespace configuration
namespace: hyperfleet-system

# =============================================================================
# HyperFleet API Configuration
# =============================================================================
hyperfleetApi:
  # Deployment configuration
  replicaCount: 1

  # Image configuration
  image:
    registry: quay.io/cdoan0
    repository: hyperfleet-api
    tag: "latest"
    pullPolicy: Always

  # Service Account configuration
  serviceAccount:
    create: true
    name: hyperfleet-api-sa
    annotations: {}

  # Server bind addresses
  server:
    bindAddress: ":8000"
    healthBindAddress: ":8080"
    metricsBindAddress: ":9090"

  # Service configuration
  service:
    type: ClusterIP
    port: 8000
    healthPort: 8080
    metricsPort: 9090

  # Database configuration
  database:
    # Built-in PostgreSQL for development/testing
    postgresql:
      enabled: false  # Changed to false - using external RDS
      image: docker.io/library/postgres:14.2
      database: hyperfleet
      user: hyperfleet
      password: hyperfleet-dev-password
      port: 5432
      resources:
        limits:
          cpu: 500m
          memory: 512Mi
        requests:
          cpu: 100m
          memory: 128Mi
      persistence:
        enabled: false
        size: 1Gi
        storageClass: ""

    # External RDS configuration (production mode)
    external:
      enabled: true  # Changed to true - using RDS
      usePodIdentity: true
      secretMountPath: /mnt/secrets-store
      sslMode: require

  # AWS Pod Identity configuration
  aws:
    region: us-east-1
    podIdentity:
      enabled: true
      roleArn: ""

  # Authentication configuration
  auth:
    enableJwt: true
    enableAuthz: false
    jwksUrl: "https://sso.redhat.com/auth/realms/redhat-external/protocol/openid-connect/certs"

  # Adapter configuration (REQUIRED)
  adapters:
    cluster: []
    nodepool: []

  # Pod security context
  podSecurityContext:
    fsGroup: 65532
    runAsNonRoot: true
    runAsUser: 65532

  # Container security context
  securityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
      - ALL
    readOnlyRootFilesystem: true
    seccompProfile:
      type: RuntimeDefault

  # Resources
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 128Mi

  # Health probe configuration
  probes:
    liveness:
      initialDelaySeconds: 30
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
    readiness:
      initialDelaySeconds: 10
      periodSeconds: 5
      timeoutSeconds: 3
      failureThreshold: 3

  # ServiceMonitor for Prometheus Operator
  serviceMonitor:
    enabled: false
    interval: 30s
    scrapeTimeout: 10s
    labels: {}

  # Additional environment variables
  env: []

  # Node selector
  nodeSelector: {}

  # Tolerations
  tolerations: []

  # Affinity
  affinity: {}

# =============================================================================
# HyperFleet Sentinel Configuration
# =============================================================================
hyperfleetSentinel:
  # Deployment configuration
  replicaCount: 1

  # Image configuration
  image:
    registry: quay.io/cdoan0
    repository: sentinel
    tag: "latest"
    pullPolicy: Always

  # Service Account configuration
  serviceAccount:
    create: true
    name: sentinel-sa
    annotations: {}

  # Service configuration
  service:
    type: ClusterIP
    port: 8080

  # Sentinel configuration
  config:
    # Resource type to watch (clusters or nodepools)
    resourceType: clusters

    # How often to poll the API for resource updates
    pollInterval: 5s

    # Max age interval for resources not ready
    maxAgeNotReady: 10s

    # Max age interval for ready resources
    maxAgeReady: 30m

    # Resource selector for horizontal sharding
    resourceSelector: []

    # HyperFleet API configuration
    hyperfleetApi:
      baseUrl: "http://hyperfleet-api.hyperfleet-system.svc.cluster.local:8000"
      timeout: 5s

    # CloudEvents data payload configuration
    messageData:
      resource_id: .id
      resource_type: .kind
      href: .href
      generation: .generation

  # Broker configuration
  broker:
    type: rabbitmq
    topic: "hyperfleet-clusters"

    # In-cluster RabbitMQ (development mode)
    rabbitmq:
      enabled: false  # Changed to false - using external Amazon MQ
      url: "amqp://hyperfleet:hyperfleet-dev-password@rabbitmq.rabbitmq.svc.cluster.local:5672/"
      exchangeType: topic

    # External Amazon MQ (production mode)
    external:
      enabled: true  # Changed to true - using Amazon MQ
      usePodIdentity: true
      secretMountPath: /mnt/secrets-store
      useTLS: true  # AMQPS (URL with credentials from AWS Secrets Manager)
      exchange: "hyperfleet-clusters"  # Topic exchange name
      exchangeType: "topic"  # Exchange type

  # AWS Pod Identity configuration
  aws:
    region: us-east-1  # Overridden by deployment-specific values
    podIdentity:
      enabled: true
      roleArn: ""  # Populated from Terraform output: hyperfleet_sentinel_role_arn

  # Pod security context
  podSecurityContext:
    fsGroup: 65532
    runAsNonRoot: true
    runAsUser: 65532

  # Container security context
  securityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
      - ALL
    readOnlyRootFilesystem: true
    seccompProfile:
      type: RuntimeDefault

  # Resources
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 128Mi

  # Health probe configuration
  probes:
    liveness:
      initialDelaySeconds: 15
      periodSeconds: 20
      timeoutSeconds: 5
      failureThreshold: 3
    readiness:
      initialDelaySeconds: 5
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3

  # Node selector
  nodeSelector: {}

  # Tolerations
  tolerations: []

  # Affinity
  affinity: {}

# =============================================================================
# HyperFleet Adapter Configuration
# =============================================================================
hyperfleetAdapter:
  # Deployment configuration
  replicaCount: 1

  # Image configuration
  image:
    registry: quay.io/cdoan0
    repository: hyperfleet-adapter
    tag: "latest"
    pullPolicy: Always

  # Service Account configuration
  serviceAccount:
    create: true
    name: hyperfleet-adapter-sa
    annotations: {}

  # RBAC configuration
  rbac:
    create: true
    resources:
      - namespaces
      - serviceaccounts

  # Adapter configuration
  adapterConfig:
    create: true
    hyperfleetApi:
      baseUrl: "http://hyperfleet-api.hyperfleet-system.svc.cluster.local:8000"
      version: "v1"
    maestro:
      # Enable Maestro client for advanced resource management
      enabled: true
      grpcServerAddress: "maestro-grpc.maestro-server.svc.cluster.local:8090"
      httpServerAddress: "http://maestro-http.maestro-server.svc.cluster.local:8080"
      sourceId: "hyperfleet-adapter"
      clientId: "hyperfleet-adapter-client"
      timeout: "30s"
      retryAttempts: 3
      retryBackoff: "exponential"
      # TLS configuration (set insecure: true for development)
      insecure: true
      auth:
        type: "none"  # Use "tls" for production with certificates
        tlsConfig:
          caFile: ""
          certFile: ""
          keyFile: ""
    log:
      level: info

  # Adapter task configuration
  adapterTaskConfig:
    create: true

  # Broker configuration
  broker:
    create: true
    type: rabbitmq

    # In-cluster RabbitMQ (development mode)
    rabbitmq:
      enabled: false  # Changed to false - using external Amazon MQ
      url: "amqp://hyperfleet:hyperfleet-dev-password@rabbitmq.rabbitmq.svc.cluster.local:5672/"
      queue: "hyperfleet-clusters-landing-zone"
      exchange: "hyperfleet-clusters"
      routingKey: "#"

    # External Amazon MQ (production mode)
    external:
      enabled: true  # Changed to true - using Amazon MQ
      usePodIdentity: true
      secretMountPath: /mnt/secrets-store
      useTLS: true  # AMQPS (URL with credentials from AWS Secrets Manager)
      queue: "hyperfleet-clusters-landing-zone"  # Queue name for adapter
      exchange: "hyperfleet-clusters"  # Topic exchange name
      routingKey: "#"  # Routing pattern (# = all messages)

  # AWS Pod Identity configuration
  aws:
    region: us-east-1  # Overridden by deployment-specific values
    podIdentity:
      enabled: true
      roleArn: ""  # Populated from Terraform output: hyperfleet_adapter_role_arn

  # Pod security context
  podSecurityContext:
    fsGroup: 65532
    runAsNonRoot: true
    runAsUser: 65532

  # Container security context
  securityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
      - ALL
    readOnlyRootFilesystem: true
    seccompProfile:
      type: RuntimeDefault

  # Resources
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 128Mi

  # Health probe configuration
  probes:
    liveness:
      enabled: true
      path: /healthz
      port: 8080
      initialDelaySeconds: 15
      periodSeconds: 20
      timeoutSeconds: 5
      failureThreshold: 3
    readiness:
      enabled: true
      path: /readyz
      port: 8080
      initialDelaySeconds: 5
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3

  # Container ports
  containerPorts:
    - name: http
      containerPort: 8080
      protocol: TCP
    - name: metrics
      containerPort: 9090
      protocol: TCP

  # Node selector
  nodeSelector: {}

  # Tolerations
  tolerations: []

  # Affinity
  affinity: {}
