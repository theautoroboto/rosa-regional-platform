version: 0.2

env:
  shell: bash
  exported-variables:
    - CENTRAL_ACCOUNT_ID
    - TF_STATE_REGION
    - TF_VAR_target_account_id
    - TF_VAR_target_alias

phases:
  install:
    commands:
      - chmod +x ./scripts/pipeline-common/install-terraform.sh ./scripts/pipeline-common/pipeline-destroy.sh
      - ./scripts/pipeline-common/install-terraform.sh

  pre_build:
    commands:
      - source scripts/pipeline-common/setup-apply-preflight.sh
      - |
        # Management cluster uses Terraform provider assume_role for cross-account access
        if [ "$TARGET_ACCOUNT_ID" != "$CENTRAL_ACCOUNT_ID" ]; then
            echo "✅ Terraform will assume OrganizationAccountAccessRole in account $TARGET_ACCOUNT_ID"
        else
            echo "✅ Destroying resources in central account - no role assumption needed"
        fi
        echo ""

  build:
    commands:
      - ./scripts/pipeline-common/pipeline-destroy.sh management

  post_build:
    commands:
      - echo "Destroy phase complete."
artifacts:
  files:
    - '**/*'
