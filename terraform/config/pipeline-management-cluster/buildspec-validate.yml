version: 0.2

env:
  shell: bash

phases:
  install:
    commands:
      - ./scripts/pipeline-common/install-terraform.sh
      - chmod +x ./scripts/pipeline-common/run-terraform-validate.sh

  pre_build:
    commands:
      - echo "=========================================="
      - echo "Pre-flight Setup"
      - echo "=========================================="
      - source ./scripts/pipeline-common/detect-central-state.sh
      - source ./scripts/pipeline-common/assume-target-role.sh "Secrets Manager operations"

  build:
    commands:
      - ./scripts/pipeline-common/run-terraform-validate.sh management

  post_build:
    commands:
      - echo "Validation complete."
      - |
        if [ -f terraform/config/management-cluster/plan-summary.txt ]; then
          echo "=== Terraform Plan Summary ==="
          cat terraform/config/management-cluster/plan-summary.txt
        fi

artifacts:
  files:
    - '**/*'
