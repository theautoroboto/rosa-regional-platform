version: 0.2

env:
  shell: bash

phases:
  install:
    commands:
      - ./scripts/pipeline-common/terraform-install.sh

  pre_build:
    commands:
      - echo "=========================================="
      - echo "Pre-flight Setup"
      - echo "=========================================="
      - source ./scripts/pipeline-common/detect-central-state.sh
      - |
        set -euo pipefail

        # Validate required environment variables
        if [[ -z "${TARGET_ACCOUNT_ID:-}" || -z "${TARGET_REGION:-}" || -z "${TARGET_ALIAS:-}" ]]; then
            echo "‚ùå ERROR: Required environment variables not set"
            echo "   TARGET_ACCOUNT_ID: ${TARGET_ACCOUNT_ID:-}"
            echo "   TARGET_REGION: ${TARGET_REGION:-}"
            echo "   TARGET_ALIAS: ${TARGET_ALIAS:-}"
            exit 1
        fi

        echo "Target Account: $TARGET_ACCOUNT_ID"
        echo "Target Region: $TARGET_REGION"
        echo "Target Alias: $TARGET_ALIAS"
        echo ""
      - source ./scripts/pipeline-common/assume-target-role.sh "Secrets Manager operations"
      - export TF_VAR_target_alias="${TARGET_ALIAS}"

  build:
    commands:
      - ./scripts/pipeline-common/terraform-validate.sh management

  post_build:
    commands:
      - echo "Validation complete."
      - |
        if [ -f terraform/config/management-cluster/plan-summary.txt ]; then
          echo "=== Terraform Plan Summary ==="
          cat terraform/config/management-cluster/plan-summary.txt
        fi

artifacts:
  files:
    - '**/*'
