version: 0.2

env:
  shell: bash

phases:
  install:
    commands:
      - ./scripts/pipeline-common/install-terraform.sh

  pre_build:
    commands:
      - echo "=========================================="
      - echo "Pre-flight Setup"
      - echo "=========================================="
      - source ./scripts/pipeline-common/detect-central-state.sh
      - |
        set -euo pipefail

        # Validate required environment variables
        if [[ -z "${TARGET_ACCOUNT_ID:-}" || -z "${TARGET_REGION:-}" || -z "${TARGET_ALIAS:-}" ]]; then
            echo "❌ ERROR: Required environment variables not set"
            echo "   TARGET_ACCOUNT_ID: ${TARGET_ACCOUNT_ID:-}"
            echo "   TARGET_REGION: ${TARGET_REGION:-}"
            echo "   TARGET_ALIAS: ${TARGET_ALIAS:-}"
            exit 1
        fi

        echo "Target Account: $TARGET_ACCOUNT_ID"
        echo "Target Region: $TARGET_REGION"
        echo "Target Alias: $TARGET_ALIAS"
        echo ""
      - source ./scripts/pipeline-common/assume-target-role.sh "Secrets Manager operations"
      - export TF_VAR_target_alias="${TARGET_ALIAS}"

  build:
    commands:
      - echo "Validating Management Cluster Configuration..."
      - |
        set -euo pipefail

        echo "---------------------------------------------------"
        echo "Validating Target: $TARGET_ALIAS ($TARGET_ACCOUNT_ID) in $TARGET_REGION"
        if [ "$TARGET_ACCOUNT_ID" != "$CENTRAL_ACCOUNT_ID" ]; then
            echo "  Terraform will assume OrganizationAccountAccessRole"
        else
            echo "  Using central account credentials"
        fi
        echo ""

        # Set Terraform backend config (state bucket is in central account, region detected in pre_build)
        export TF_STATE_BUCKET="terraform-state-${CENTRAL_ACCOUNT_ID}"
        export TF_STATE_KEY="management-cluster/${TARGET_ALIAS}.tfstate"

        # Resolve REGIONAL_AWS_ACCOUNT_ID (supports both direct values and SSM parameter references)
        RESOLVED_REGIONAL_ACCOUNT_ID="${REGIONAL_AWS_ACCOUNT_ID}"

        # If value is an SSM parameter reference (starts with ssm:/), fetch from Parameter Store
        if [[ "$RESOLVED_REGIONAL_ACCOUNT_ID" =~ ^ssm:/ ]]; then
            SSM_PARAM_NAME="${RESOLVED_REGIONAL_ACCOUNT_ID#ssm:}"
            echo "Resolving SSM parameter: $SSM_PARAM_NAME in region ${TARGET_REGION}"

            RESOLVED_REGIONAL_ACCOUNT_ID=$(aws ssm get-parameter \
                --name "$SSM_PARAM_NAME" \
                --with-decryption \
                --query 'Parameter.Value' \
                --output text \
                --region "${TARGET_REGION}")

            echo "✓ Resolved regional account ID: $RESOLVED_REGIONAL_ACCOUNT_ID"
        fi

        # Validate that REGIONAL_AWS_ACCOUNT_ID is non-empty
        if [[ -z "$RESOLVED_REGIONAL_ACCOUNT_ID" ]]; then
            echo "❌ ERROR: REGIONAL_AWS_ACCOUNT_ID must be provided for region ${TARGET_REGION}"
            echo "   Set this in your management cluster config (either direct account ID or ssm:/path/to/param)"
            exit 1
        fi

        # Export required Terraform variables
        export TF_VAR_region="${TARGET_REGION}"
        export TF_VAR_app_code="${APP_CODE}"
        export TF_VAR_service_phase="${SERVICE_PHASE}"
        export TF_VAR_cost_center="${COST_CENTER}"
        export TF_VAR_repository_url="${REPOSITORY_URL}"
        export TF_VAR_repository_branch="${REPOSITORY_BRANCH}"
        export TF_VAR_cluster_id="${CLUSTER_ID:-mgmt-cluster-01}"
        export TF_VAR_regional_aws_account_id="${RESOLVED_REGIONAL_ACCOUNT_ID}"
        export TF_VAR_target_account_id="${TARGET_ACCOUNT_ID}"

        # Create placeholder Maestro agent secrets in target account (using assumed credentials from pre_build)
        echo "Ensuring Maestro agent secrets exist in account ${TARGET_ACCOUNT_ID}..."

        for SECRET_NAME in "maestro/agent-cert" "maestro/agent-config"; do
            # Check if secret exists (using target account credentials)
            if ! AWS_ACCESS_KEY_ID="$TARGET_AWS_ACCESS_KEY_ID" \
                 AWS_SECRET_ACCESS_KEY="$TARGET_AWS_SECRET_ACCESS_KEY" \
                 AWS_SESSION_TOKEN="$TARGET_AWS_SESSION_TOKEN" \
                 aws secretsmanager describe-secret --secret-id "$SECRET_NAME" --region ${TARGET_REGION} 2>/dev/null; then

                echo "Creating placeholder secret: $SECRET_NAME"
                if ! CREATE_OUTPUT=$(AWS_ACCESS_KEY_ID="$TARGET_AWS_ACCESS_KEY_ID" \
                                     AWS_SECRET_ACCESS_KEY="$TARGET_AWS_SECRET_ACCESS_KEY" \
                                     AWS_SESSION_TOKEN="$TARGET_AWS_SESSION_TOKEN" \
                                     aws secretsmanager create-secret \
                                     --name "$SECRET_NAME" \
                                     --description "Placeholder secret for Maestro agent (created by buildspec)" \
                                     --secret-string '{"placeholder":true}' \
                                     --region ${TARGET_REGION} 2>&1); then

                    # Check if failure is due to secret already existing (race condition)
                    if echo "$CREATE_OUTPUT" | grep -q "ResourceExistsException"; then
                        echo "Secret $SECRET_NAME already exists (created concurrently)"
                    else
                        echo "❌ Failed to create secret $SECRET_NAME"
                        echo "Error: $CREATE_OUTPUT"
                        exit 1
                    fi
                else
                    echo "✓ Created secret $SECRET_NAME"
                fi
            else
                echo "Secret $SECRET_NAME already exists"
            fi
        done

        echo "Maestro agent placeholder secrets verified"
        echo ""

        # Restore central account credentials for Terraform backend access
        echo "Restoring central account credentials for Terraform backend access..."
        export AWS_ACCESS_KEY_ID="${CENTRAL_AWS_ACCESS_KEY_ID}"
        export AWS_SECRET_ACCESS_KEY="${CENTRAL_AWS_SECRET_ACCESS_KEY}"
        export AWS_SESSION_TOKEN="${CENTRAL_AWS_SESSION_TOKEN}"

        # Verify we're back to central account
        CURRENT_ACCOUNT=$(aws sts get-caller-identity --query Account --output text)
        echo "Current account: $CURRENT_ACCOUNT (central: $CENTRAL_ACCOUNT_ID)"

        # Initialize Terraform
        echo "Initializing Terraform..."
        cd terraform/config/management-cluster
        terraform init -reconfigure \
            -backend-config="bucket=${TF_STATE_BUCKET}" \
            -backend-config="key=${TF_STATE_KEY}" \
            -backend-config="region=${TF_STATE_REGION}" \
            -backend-config="use_lockfile=true"

        echo "Validating Terraform configuration..."
        terraform validate

        echo "Running Terraform plan..."
        if ! terraform plan -out=tfplan; then
            echo "❌ Terraform plan failed"
            cd ../../..
            exit 1
        fi

        # Save plan summary
        terraform show -no-color tfplan > plan-summary.txt
        echo "✓ Plan summary saved to plan-summary.txt"

        cd ../../..

  post_build:
    commands:
      - echo "Validation complete."
      - |
        if [ -f terraform/config/management-cluster/plan-summary.txt ]; then
          echo "=== Terraform Plan Summary ==="
          cat terraform/config/management-cluster/plan-summary.txt
        fi

artifacts:
  files:
    - '**/*'
