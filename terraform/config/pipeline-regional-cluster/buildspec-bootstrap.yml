version: 0.2

env:
  shell: bash
  exported-variables:
    - CENTRAL_ACCOUNT_ID
    - TF_STATE_REGION
    - TARGET_AWS_ACCESS_KEY_ID
    - TARGET_AWS_SECRET_ACCESS_KEY
    - TARGET_AWS_SESSION_TOKEN
    - SAVE_AWS_ACCESS_KEY_ID
    - SAVE_AWS_SECRET_ACCESS_KEY
    - SAVE_AWS_SESSION_TOKEN
    - TF_VAR_target_account_id
    - TF_VAR_target_alias

phases:
  install:
    commands:
      - echo "Installing dependencies..."
      - yum install -y unzip python3 jq gnupg2
      - pip3 install boto3 pyyaml
      - echo "Installing kubectl..."
      - |
        set -euo pipefail
        KUBECTL_VERSION="v1.31.0"

        # Download kubectl binary and checksum
        echo "Downloading kubectl ${KUBECTL_VERSION}..."
        curl -sSfLO "https://dl.k8s.io/release/${KUBECTL_VERSION}/bin/linux/amd64/kubectl"
        curl -sSfLO "https://dl.k8s.io/release/${KUBECTL_VERSION}/bin/linux/amd64/kubectl.sha256"

        # Verify checksum
        echo "Verifying kubectl checksum..."
        if ! echo "$(cat kubectl.sha256)  kubectl" | sha256sum -c -; then
          echo "❌ kubectl checksum verification failed"
          exit 1
        fi
        echo "✓ kubectl checksum verified"

        # Install kubectl
        chmod +x kubectl
        mv kubectl /usr/local/bin/
        rm -f kubectl.sha256

        kubectl version --client
        echo "✓ kubectl installation verified"
      - chmod +x scripts/dev/validate-argocd-config.sh scripts/bootstrap-argocd.sh scripts/pipeline-common/setup-credentials.sh
      - echo "Installing Terraform (needed to read outputs)..."
      - |
        set -euo pipefail
        TF_VERSION="1.14.3"
        TF_PACKAGE="terraform_${TF_VERSION}_linux_amd64.zip"
        TF_BASE_URL="https://releases.hashicorp.com/terraform/${TF_VERSION}"

        # Download Terraform package and verification files
        echo "Downloading Terraform ${TF_VERSION}..."
        curl -sSfO "${TF_BASE_URL}/${TF_PACKAGE}"
        curl -sSfO "${TF_BASE_URL}/terraform_${TF_VERSION}_SHA256SUMS"
        curl -sSfO "${TF_BASE_URL}/terraform_${TF_VERSION}_SHA256SUMS.sig"

        # Import HashiCorp GPG key
        echo "Importing HashiCorp GPG key..."
        gpg --batch --keyserver keyserver.ubuntu.com --recv-keys \
          C874011F0AB405110D02105534365D9472D7468F || \
        gpg --batch --keyserver keys.openpgp.org --recv-keys \
          C874011F0AB405110D02105534365D9472D7468F || \
        gpg --batch --keyserver pgp.mit.edu --recv-keys \
          C874011F0AB405110D02105534365D9472D7468F

        # Verify GPG signature on SHA256SUMS
        echo "Verifying GPG signature..."
        if ! gpg --batch --verify "terraform_${TF_VERSION}_SHA256SUMS.sig" "terraform_${TF_VERSION}_SHA256SUMS"; then
          echo "❌ GPG signature verification failed"
          exit 1
        fi
        echo "✓ GPG signature verified"

        # Verify checksum of Terraform package
        echo "Verifying SHA256 checksum..."
        if ! grep "${TF_PACKAGE}" "terraform_${TF_VERSION}_SHA256SUMS" | sha256sum -c -; then
          echo "❌ Checksum verification failed"
          exit 1
        fi
        echo "✓ Checksum verified"

        # Install Terraform
        echo "Installing Terraform..."
        unzip -o "${TF_PACKAGE}" -d /tmp/tf-bin
        mv /tmp/tf-bin/terraform /usr/local/bin/

        # Cleanup
        rm -f "${TF_PACKAGE}" "terraform_${TF_VERSION}_SHA256SUMS" "terraform_${TF_VERSION}_SHA256SUMS.sig"

        terraform version
        echo "✓ Terraform installation verified"

  pre_build:
    commands:
      - source scripts/pipeline-common/setup-credentials.sh

  build:
    commands:
      - echo "Bootstrapping ArgoCD on Regional Cluster..."
      - |
        bootstrap_target() {
            local ACCOUNT_ID=$1
            local REGION=$2
            local ALIAS=$3

            echo "---------------------------------------------------"
            echo "Bootstrapping ArgoCD: $ALIAS ($ACCOUNT_ID) in $REGION"
            echo "  Central Account (for S3 state): ${CENTRAL_ACCOUNT_ID}"
            echo ""

            # Restore central account credentials for Terraform backend access
            echo "Restoring central account credentials for Terraform backend access..."
            export AWS_ACCESS_KEY_ID="${SAVE_AWS_ACCESS_KEY_ID}"
            export AWS_SECRET_ACCESS_KEY="${SAVE_AWS_SECRET_ACCESS_KEY}"
            export AWS_SESSION_TOKEN="${SAVE_AWS_SESSION_TOKEN}"

            # Verify we're back to central account
            CURRENT_ACCOUNT=$(aws sts get-caller-identity --query Account --output text)
            echo "Current account: $CURRENT_ACCOUNT (central: $CENTRAL_ACCOUNT_ID)"
            echo ""

            # Configure Terraform region via environment variable (HashiCorp recommended approach)
            export TF_VAR_region="${REGION}"

            # Configure Terraform backend (state in central account, region detected in pre_build)
            export TF_STATE_BUCKET="terraform-state-${CENTRAL_ACCOUNT_ID}"
            export TF_STATE_KEY="regional-cluster/${ALIAS}.tfstate"


            echo "Terraform backend configuration:"
            echo "  Bucket: $TF_STATE_BUCKET (in central account)"
            echo "  Key: $TF_STATE_KEY"
            echo "  Region: $TF_STATE_REGION"
            echo ""

            echo "Initializing Terraform (uses central account credentials for S3 backend)..."
            (
                cd terraform/config/regional-cluster
                terraform init -reconfigure \
                    -backend-config="bucket=${TF_STATE_BUCKET}" \
                    -backend-config="key=${TF_STATE_KEY}" \
                    -backend-config="region=${TF_STATE_REGION}" \
                    -backend-config="use_lockfile=true"
            )

            # Bootstrap ArgoCD
            # The script reads terraform outputs with central creds, then assumes role internally for ECS/EKS

            echo "Validating ArgoCD configuration..."
            ./scripts/dev/validate-argocd-config.sh regional-cluster

            echo "Checking terraform outputs are available..."
            (
                cd terraform/config/regional-cluster
                if ! terraform output -json > /tmp/tf-outputs.json 2>&1; then
                    echo "❌ Failed to read terraform outputs"
                    cat /tmp/tf-outputs.json
                    exit 1
                fi
                echo "✓ Terraform outputs available:"
                jq 'keys' /tmp/tf-outputs.json
            )

            echo "Bootstrapping ArgoCD..."

            # Initialize ENVIRONMENT with safe fallbacks (handles both ENVIRONMENT and TARGET_ENVIRONMENT)
            local ENV_VALUE="${ENVIRONMENT:-${TARGET_ENVIRONMENT:-}}"

            # Validate all required environment variables are set (using safe parameter expansion)
            if [[ -z "${ENV_VALUE:-}" ]]; then
                echo "❌ ERROR: ENVIRONMENT variable not set"
                exit 1
            fi

            # Export standardized environment variables for bootstrap script
            # The script expects: ENVIRONMENT, REGION_ALIAS, AWS_REGION
            export ENVIRONMENT="${ENV_VALUE}"
            export REGION_ALIAS="${ALIAS}"
            export AWS_REGION="${REGION}"

            # Set ASSUME_ROLE_ARN for cross-account bootstrap (if needed)
            # The script will read terraform outputs with current (central) creds,
            # then assume this role for ECS/EKS operations
            if [ "$ACCOUNT_ID" != "$CENTRAL_ACCOUNT_ID" ]; then
                export ASSUME_ROLE_ARN="arn:aws:iam::${ACCOUNT_ID}:role/OrganizationAccountAccessRole"
                echo "Bootstrap will assume role for target account operations: $ASSUME_ROLE_ARN"
            fi

            echo "Bootstrap environment configuration:"
            echo "  ENVIRONMENT: ${ENVIRONMENT}"
            echo "  REGION_ALIAS: ${REGION_ALIAS}"
            echo "  AWS_REGION: ${AWS_REGION}"
            echo ""

            # Call bootstrap script with central account credentials (for terraform output reading)
            # The script will internally assume ASSUME_ROLE_ARN for ECS/EKS operations
            ./scripts/bootstrap-argocd.sh regional-cluster 2>&1 | tee /tmp/bootstrap.log
            BOOTSTRAP_EXIT_CODE=${PIPESTATUS[0]}

            echo ""
            echo "=== Bootstrap Script Log ==="
            cat /tmp/bootstrap.log
            echo "=== End Bootstrap Log ==="
            echo ""

            if [ $BOOTSTRAP_EXIT_CODE -ne 0 ]; then
                echo "❌ Bootstrap script failed with exit code $BOOTSTRAP_EXIT_CODE"
                exit 1
            fi
        }

        # This buildspec is called by the pipeline with TARGET_* environment variables
        if [[ -n "$TARGET_ACCOUNT_ID" && -n "$TARGET_REGION" && -n "$TARGET_ALIAS" ]]; then
            echo "Using pipeline configuration (TARGET_* variables)"
            bootstrap_target "$TARGET_ACCOUNT_ID" "$TARGET_REGION" "$TARGET_ALIAS"
        else
            echo "ERROR: TARGET_* variables not set. This pipeline should be created by the provisioner."
            exit 1
        fi

  post_build:
    commands:
      - echo "ArgoCD bootstrap complete."
      - echo "Regional cluster is now fully provisioned and ready for use."

artifacts:
  files:
    - '**/*'
