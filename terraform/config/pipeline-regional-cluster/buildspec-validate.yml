version: 0.2

env:
  shell: bash

phases:
  install:
    commands:
      - echo "Installing dependencies..."
      - yum install -y unzip python3 jq gnupg2
      - pip3 install boto3
      - echo "Installing Terraform..."
      - |
        set -euo pipefail
        TF_VERSION="1.14.3"
        TF_PACKAGE="terraform_${TF_VERSION}_linux_amd64.zip"
        TF_BASE_URL="https://releases.hashicorp.com/terraform/${TF_VERSION}"

        # Download Terraform package and verification files
        echo "Downloading Terraform ${TF_VERSION}..."
        curl -sSfO "${TF_BASE_URL}/${TF_PACKAGE}"
        curl -sSfO "${TF_BASE_URL}/terraform_${TF_VERSION}_SHA256SUMS"
        curl -sSfO "${TF_BASE_URL}/terraform_${TF_VERSION}_SHA256SUMS.sig"

        # Import HashiCorp GPG key
        echo "Importing HashiCorp GPG key..."
        gpg --batch --keyserver keyserver.ubuntu.com --recv-keys \
          C874011F0AB405110D02105534365D9472D7468F || \
        gpg --batch --keyserver keys.openpgp.org --recv-keys \
          C874011F0AB405110D02105534365D9472D7468F || \
        gpg --batch --keyserver pgp.mit.edu --recv-keys \
          C874011F0AB405110D02105534365D9472D7468F

        # Verify GPG signature on SHA256SUMS
        echo "Verifying GPG signature..."
        if ! gpg --batch --verify "terraform_${TF_VERSION}_SHA256SUMS.sig" "terraform_${TF_VERSION}_SHA256SUMS"; then
          echo "❌ GPG signature verification failed"
          exit 1
        fi
        echo "✓ GPG signature verified"

        # Verify checksum of Terraform package
        echo "Verifying SHA256 checksum..."
        if ! grep "${TF_PACKAGE}" "terraform_${TF_VERSION}_SHA256SUMS" | sha256sum -c -; then
          echo "❌ Checksum verification failed"
          exit 1
        fi
        echo "✓ Checksum verified"

        # Install Terraform
        echo "Installing Terraform..."
        unzip -o "${TF_PACKAGE}" -d /tmp/tf-bin
        mv /tmp/tf-bin/terraform /usr/local/bin/

        # Cleanup
        rm -f "${TF_PACKAGE}" "terraform_${TF_VERSION}_SHA256SUMS" "terraform_${TF_VERSION}_SHA256SUMS.sig"

        terraform version
        echo "✓ Terraform installation verified"

  pre_build:
    commands:
      - echo "=========================================="
      - echo "Pre-flight Setup"
      - echo "=========================================="
      - source ./scripts/pipeline-common/detect-central-state.sh

  build:
    commands:
      - echo "Validating Regional Cluster Configurations..."
      - |
        set -euo pipefail

        # Helper function: Resolve account ID from SSM or Secrets Manager
        resolve_account_id() {
            local val="$1"
            if [[ "$val" == ssm:* ]]; then
                local param_name="${val#ssm:}"
                echo "Resolving account ID from SSM: $param_name" >&2
                aws ssm get-parameter --name "$param_name" --with-decryption --query Parameter.Value --output text
            elif [[ "$val" == secretsmanager:* ]]; then
                local secret_name="${val#secretsmanager:}"
                echo "Resolving account ID from Secrets Manager: $secret_name" >&2
                aws secretsmanager get-secret-value --secret-id "$secret_name" --query SecretString --output text
            else
                echo "$val"
            fi
        }

        validate_target() {
            local ACCOUNT_ID=$1
            local REGION=$2
            local ALIAS=$3

            echo "---------------------------------------------------"
            echo "Validating Target: $ALIAS ($ACCOUNT_ID) in $REGION"
            if [ "$ACCOUNT_ID" != "$CENTRAL_ACCOUNT_ID" ]; then
                echo "  Terraform will assume OrganizationAccountAccessRole"
            else
                echo "  Using central account credentials"
            fi
            echo ""

            # State bucket is in central account (region detected in pre_build)
            export TF_STATE_BUCKET="terraform-state-${CENTRAL_ACCOUNT_ID}"
            export TF_STATE_KEY="regional-cluster/${ALIAS}.tfstate"

            # Set Terraform variables (provider will handle assume role if needed)
            export TF_VAR_region=$REGION
            export TF_VAR_target_account_id="$ACCOUNT_ID"
            export TF_VAR_target_alias="$ALIAS"
            export TF_VAR_app_code="infra"
            export TF_VAR_service_phase="prod"
            export TF_VAR_cost_center="000"
            export TF_VAR_repository_url="https://github.com/${GITHUB_REPO_OWNER}/${GITHUB_REPO_NAME}.git"
            export TF_VAR_repository_branch="${GITHUB_BRANCH:-main}"
            export TF_VAR_api_additional_allowed_accounts="$ACCOUNT_ID"

            # Run terraform operations in subshell to ensure directory isolation
            # If any command fails, subshell exits but parent directory is preserved
            (
                echo "Initializing Terraform..."
                cd terraform/config/regional-cluster
                terraform init \
                    -reconfigure \
                    -backend-config="bucket=$TF_STATE_BUCKET" \
                    -backend-config="key=$TF_STATE_KEY" \
                    -backend-config="region=$TF_STATE_REGION" \
                    -backend-config="use_lockfile=true"

                echo "Validating Terraform configuration..."
                terraform validate

                echo "Running Terraform plan..."
                terraform plan -out=tfplan

                # Save plan summary
                terraform show -no-color tfplan > plan-summary.txt
                echo "Plan summary saved to plan-summary.txt"
            )
        }

        # Process Manual Overrides if present
        if [[ -n "$TARGET_ACCOUNT_ID" && -n "$TARGET_REGION" && -n "$TARGET_ALIAS" ]]; then
            echo "Detected Manual Configuration Override."
            validate_target "$TARGET_ACCOUNT_ID" "$TARGET_REGION" "$TARGET_ALIAS"
        fi

        # Process JSON Files
        for file in deploy/*/*/terraform/regional.json; do
            [ -e "$file" ] || continue

            ACCOUNT_ID=$(jq -r '.account_id // ""' "$file")
            REGION=$(jq -r '.region // ""' "$file")
            ALIAS=$(jq -r '.alias // ""' "$file")

            # Skip if any required field is missing
            if [[ -z "$ACCOUNT_ID" || -z "$REGION" || -z "$ALIAS" ]]; then
                echo "Skipping $file (missing account_id, region, or alias)"
                continue
            fi

            # Skip if account_id is not a valid 12-digit AWS account ID
            if [[ ! "$ACCOUNT_ID" =~ ^[0-9]{12}$ ]]; then
                echo "Skipping $file (invalid account_id: $ACCOUNT_ID - must be 12 digits)"
                continue
            fi

            validate_target "$ACCOUNT_ID" "$REGION" "$ALIAS"
        done

  post_build:
    commands:
      - echo "Validation complete."
      - |
        if [ -f terraform/config/regional-cluster/plan-summary.txt ]; then
          echo "=== Terraform Plan Summary ==="
          cat terraform/config/regional-cluster/plan-summary.txt
        fi

artifacts:
  files:
    - '**/*'
