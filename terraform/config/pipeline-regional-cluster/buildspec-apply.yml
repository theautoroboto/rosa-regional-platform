version: 0.2

env:
  shell: bash

phases:
  install:
    commands:
      - echo "Installing dependencies..."
      - yum install -y unzip python3 jq gnupg2
      - pip3 install boto3 pyyaml
      - echo "Installing Terraform..."
      - |
        set -euo pipefail
        TF_VERSION="1.14.3"
        TF_PACKAGE="terraform_${TF_VERSION}_linux_amd64.zip"
        TF_BASE_URL="https://releases.hashicorp.com/terraform/${TF_VERSION}"

        # Download Terraform package and verification files
        echo "Downloading Terraform ${TF_VERSION}..."
        curl -sSfO "${TF_BASE_URL}/${TF_PACKAGE}"
        curl -sSfO "${TF_BASE_URL}/terraform_${TF_VERSION}_SHA256SUMS"
        curl -sSfO "${TF_BASE_URL}/terraform_${TF_VERSION}_SHA256SUMS.sig"

        # Import HashiCorp GPG key
        echo "Importing HashiCorp GPG key..."
        gpg --batch --keyserver keyserver.ubuntu.com --recv-keys \
          C874011F0AB405110D02105534365D9472D7468F || \
        gpg --batch --keyserver keys.openpgp.org --recv-keys \
          C874011F0AB405110D02105534365D9472D7468F || \
        gpg --batch --keyserver pgp.mit.edu --recv-keys \
          C874011F0AB405110D02105534365D9472D7468F

        # Verify GPG signature on SHA256SUMS
        echo "Verifying GPG signature..."
        if ! gpg --batch --verify "terraform_${TF_VERSION}_SHA256SUMS.sig" "terraform_${TF_VERSION}_SHA256SUMS"; then
          echo "❌ GPG signature verification failed"
          exit 1
        fi
        echo "✓ GPG signature verified"

        # Verify checksum of Terraform package
        echo "Verifying SHA256 checksum..."
        if ! grep "${TF_PACKAGE}" "terraform_${TF_VERSION}_SHA256SUMS" | sha256sum -c -; then
          echo "❌ Checksum verification failed"
          exit 1
        fi
        echo "✓ Checksum verified"

        # Install Terraform
        echo "Installing Terraform..."
        unzip -o "${TF_PACKAGE}" -d /tmp/tf-bin
        mv /tmp/tf-bin/terraform /usr/local/bin/

        # Cleanup
        rm -f "${TF_PACKAGE}" "terraform_${TF_VERSION}_SHA256SUMS" "terraform_${TF_VERSION}_SHA256SUMS.sig"

        terraform version
        echo "✓ Terraform installation verified"

  pre_build:
    commands:
      - echo "=========================================="
      - echo "Pre-flight Setup"
      - echo "=========================================="
      - |
        set -euo pipefail

        # Validate required environment variables
        if [[ -z "$TARGET_ACCOUNT_ID" || -z "$TARGET_REGION" || -z "$TARGET_ALIAS" ]]; then
            echo "❌ ERROR: Required environment variables not set"
            echo "   TARGET_ACCOUNT_ID: ${TARGET_ACCOUNT_ID:-not set}"
            echo "   TARGET_REGION: ${TARGET_REGION:-not set}"
            echo "   TARGET_ALIAS: ${TARGET_ALIAS:-not set}"
            exit 1
        fi

        # Get central account ID for state bucket
        CENTRAL_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
        export CENTRAL_ACCOUNT_ID

        # Detect S3 state bucket region (bucket is in central account)
        TF_STATE_BUCKET="terraform-state-${CENTRAL_ACCOUNT_ID}"
        BUCKET_REGION=$(aws s3api get-bucket-location --bucket "$TF_STATE_BUCKET" --region us-east-1 --query LocationConstraint --output text)
        if [ "$BUCKET_REGION" == "None" ] || [ "$BUCKET_REGION" == "null" ] || [ -z "$BUCKET_REGION" ]; then BUCKET_REGION="us-east-1"; fi
        export TF_STATE_REGION=$BUCKET_REGION

        echo "Configuration:"
        echo "  Central Account: $CENTRAL_ACCOUNT_ID"
        echo "  Target Account: $TARGET_ACCOUNT_ID"
        echo "  Target Region: $TARGET_REGION"
        echo "  Target Alias: $TARGET_ALIAS"
        echo "  State Bucket Region: $TF_STATE_REGION"
        echo ""

        # Pass target account to Terraform - provider will handle assume role
        export TF_VAR_target_account_id="${TARGET_ACCOUNT_ID}"
        export TF_VAR_target_alias="${TARGET_ALIAS}"

        if [ "$TARGET_ACCOUNT_ID" != "$CENTRAL_ACCOUNT_ID" ]; then
            echo "✅ Terraform will assume OrganizationAccountAccessRole in account $TARGET_ACCOUNT_ID"
        else
            echo "✅ Deploying to central account - no role assumption needed"
        fi
        echo ""

  build:
    commands:
      - echo "Provisioning Regional Cluster Infrastructure..."
      - |
        set -euo pipefail

        echo "Deploying to account: ${TARGET_ACCOUNT_ID}"
        echo "  Region: ${TARGET_REGION}"
        echo "  Alias: ${TARGET_ALIAS}"
        echo ""

        # Configure Terraform backend (state in central account, region detected in pre_build)
        export TF_STATE_BUCKET="terraform-state-${CENTRAL_ACCOUNT_ID}"
        export TF_STATE_KEY="regional-cluster/${TARGET_ALIAS}.tfstate"

        echo "Terraform backend:"
        echo "  Bucket: $TF_STATE_BUCKET (central account: $CENTRAL_ACCOUNT_ID)"
        echo "  Key: $TF_STATE_KEY"
        echo "  Region: $TF_STATE_REGION"
        echo ""

        # Set Terraform variables
        export TF_VAR_region="${TARGET_REGION}"
        export TF_VAR_app_code="${APP_CODE}"
        export TF_VAR_service_phase="${SERVICE_PHASE}"
        export TF_VAR_cost_center="${COST_CENTER}"
        export TF_VAR_repository_url="${CODEBUILD_SOURCE_REPO_URL:-https://github.com/placeholder/repo.git}"
        export TF_VAR_repository_branch="${CODEBUILD_SOURCE_VERSION:-main}"
        export TF_VAR_api_additional_allowed_accounts="${TARGET_ACCOUNT_ID}"

        echo "Terraform variables:"
        echo "  Region: $TF_VAR_region"
        echo "  Target Account: $TF_VAR_target_account_id (Terraform will assume role if cross-account)"
        echo "  Target Alias: $TF_VAR_target_alias"
        echo "  App Code: $TF_VAR_app_code"
        echo "  Service Phase: $TF_VAR_service_phase"
        echo "  Cost Center: $TF_VAR_cost_center"
        echo "  Repository URL: $TF_VAR_repository_url"
        echo "  Repository Branch: $TF_VAR_repository_branch"
        echo "  API Additional Allowed Accounts: $TF_VAR_api_additional_allowed_accounts"
      - make pipeline-provision-regional-infra
      - echo "Regional cluster infrastructure provisioned successfully."

  post_build:
    commands:
      - echo "Infrastructure deployment complete."
      - |
        if [ -f terraform/config/regional-cluster/outputs.json ]; then
          echo "=== Terraform Outputs ==="
          cat terraform/config/regional-cluster/outputs.json
        fi

artifacts:
  files:
    - '**/*'
    - terraform/config/regional-cluster/outputs.json
