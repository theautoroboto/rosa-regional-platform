version: 0.2

env:
  shell: bash

phases:
  install:
    commands:
      - echo "Installing dependencies..."
      - yum install -y unzip python3 jq gnupg2
      - pip3 install boto3 pyyaml
      - echo "Installing Terraform..."
      - |
        set -euo pipefail
        TF_VERSION="1.14.3"
        TF_PACKAGE="terraform_${TF_VERSION}_linux_amd64.zip"
        TF_BASE_URL="https://releases.hashicorp.com/terraform/${TF_VERSION}"

        # Download Terraform package and verification files
        echo "Downloading Terraform ${TF_VERSION}..."
        curl -sSfO "${TF_BASE_URL}/${TF_PACKAGE}"
        curl -sSfO "${TF_BASE_URL}/terraform_${TF_VERSION}_SHA256SUMS"
        curl -sSfO "${TF_BASE_URL}/terraform_${TF_VERSION}_SHA256SUMS.sig"

        # Import HashiCorp GPG key
        echo "Importing HashiCorp GPG key..."
        gpg --batch --keyserver keyserver.ubuntu.com --recv-keys \
          C874011F0AB405110D02105534365D9472D7468F || \
        gpg --batch --keyserver keys.openpgp.org --recv-keys \
          C874011F0AB405110D02105534365D9472D7468F || \
        gpg --batch --keyserver pgp.mit.edu --recv-keys \
          C874011F0AB405110D02105534365D9472D7468F

        # Verify GPG signature on SHA256SUMS
        echo "Verifying GPG signature..."
        if ! gpg --batch --verify "terraform_${TF_VERSION}_SHA256SUMS.sig" "terraform_${TF_VERSION}_SHA256SUMS"; then
          echo "❌ GPG signature verification failed"
          exit 1
        fi
        echo "✓ GPG signature verified"

        # Verify checksum of Terraform package
        echo "Verifying SHA256 checksum..."
        if ! grep "${TF_PACKAGE}" "terraform_${TF_VERSION}_SHA256SUMS" | sha256sum -c -; then
          echo "❌ Checksum verification failed"
          exit 1
        fi
        echo "✓ Checksum verified"

        # Install Terraform
        echo "Installing Terraform..."
        unzip -o "${TF_PACKAGE}" -d /tmp/tf-bin
        mv /tmp/tf-bin/terraform /usr/local/bin/

        # Cleanup
        rm -f "${TF_PACKAGE}" "terraform_${TF_VERSION}_SHA256SUMS" "terraform_${TF_VERSION}_SHA256SUMS.sig"

        terraform version
        echo "✓ Terraform installation verified"

  pre_build:
    commands:
      - echo "=========================================="
      - echo "Pre-flight Checks"
      - echo "=========================================="
      - |
        set -euo pipefail

        # Validate required environment variables
        if [[ -z "$TARGET_ACCOUNT_ID" || -z "$TARGET_REGION" || -z "$TARGET_ALIAS" ]]; then
            echo "❌ ERROR: Required environment variables not set"
            echo "   TARGET_ACCOUNT_ID: ${TARGET_ACCOUNT_ID}"
            echo "   TARGET_REGION: ${TARGET_REGION}"
            echo "   TARGET_ALIAS: ${TARGET_ALIAS}"
            exit 1
        fi

        echo "Configuration:"
        echo "  Target Account: $TARGET_ACCOUNT_ID"
        echo "  Target Region: $TARGET_REGION"
        echo "  Target Alias: $TARGET_ALIAS"
        echo ""

        # Test assume role capability
        ROLE_ARN="arn:aws:iam::${TARGET_ACCOUNT_ID}:role/OrganizationAccountAccessRole"

        echo "Testing assume role capability..."
        echo "Role ARN: $ROLE_ARN"

        # Try to assume the role
        if ! ASSUMED_CREDS=$(aws sts assume-role \
            --role-arn "$ROLE_ARN" \
            --role-session-name "pipeline-preflight-check" \
            --query 'Credentials.[AccessKeyId,SecretAccessKey,SessionToken]' \
            --output text 2>&1); then
            echo "❌ FAILED: Cannot assume role $ROLE_ARN"
            echo ""
            echo "Error details:"
            echo "$ASSUMED_CREDS"
            echo ""
            echo "Common causes:"
            echo "  • OrganizationAccountAccessRole does not exist in target account"
            echo "  • Trust policy does not allow central account to assume role"
            echo "  • CodeBuild role lacks sts:AssumeRole permission"
            echo ""
            exit 1
        fi

        # Set temporary credentials
        export AWS_ACCESS_KEY_ID=$(echo $ASSUMED_CREDS | awk '{print $1}')
        export AWS_SECRET_ACCESS_KEY=$(echo $ASSUMED_CREDS | awk '{print $2}')
        export AWS_SESSION_TOKEN=$(echo $ASSUMED_CREDS | awk '{print $3}')

        # Verify we can make API calls with assumed role
        if ! ASSUMED_IDENTITY=$(aws sts get-caller-identity --query 'Account' --output text 2>&1); then
            echo "❌ FAILED: Can assume role but cannot make API calls"
            echo "Error: $ASSUMED_IDENTITY"
            unset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN
            exit 1
        fi

        # Verify we're in the correct account
        if [ "$ASSUMED_IDENTITY" != "$TARGET_ACCOUNT_ID" ]; then
            echo "❌ FAILED: Assumed role in wrong account"
            echo "  Expected: $TARGET_ACCOUNT_ID"
            echo "  Got: $ASSUMED_IDENTITY"
            unset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN
            exit 1
        fi

        echo "✅ Successfully assumed role in account $TARGET_ACCOUNT_ID"
        echo "✅ Pre-flight checks passed"
        echo ""

        # Clean up - unset assumed credentials for build phase
        unset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN

  build:
    commands:
      - echo "Provisioning Regional Cluster Infrastructure..."
      - |
        set -euo pipefail

        # Function to ensure state bucket exists with proper security settings
        ensure_state_bucket() {
            local BUCKET_NAME=$1
            local BUCKET_REGION=$2
            local TARGET_ACCOUNT=$3

            echo "Ensuring state bucket exists: $BUCKET_NAME in account $TARGET_ACCOUNT"

            # Assume role in target account to create bucket
            TEMP_CREDS=$(aws sts assume-role \
                --role-arn "arn:aws:iam::${TARGET_ACCOUNT}:role/OrganizationAccountAccessRole" \
                --role-session-name "terraform-state-bucket-creation" \
                --query 'Credentials.[AccessKeyId,SecretAccessKey,SessionToken]' \
                --output text)

            export AWS_ACCESS_KEY_ID=$(echo $TEMP_CREDS | awk '{print $1}')
            export AWS_SECRET_ACCESS_KEY=$(echo $TEMP_CREDS | awk '{print $2}')
            export AWS_SESSION_TOKEN=$(echo $TEMP_CREDS | awk '{print $3}')

            # Check if bucket exists
            if ! aws s3api head-bucket --bucket "$BUCKET_NAME" 2>/dev/null; then
                echo "Creating state bucket $BUCKET_NAME in $BUCKET_REGION..."

                if [ "$BUCKET_REGION" == "us-east-1" ]; then
                    aws s3api create-bucket --bucket "$BUCKET_NAME" --region "$BUCKET_REGION"
                else
                    aws s3api create-bucket --bucket "$BUCKET_NAME" --region "$BUCKET_REGION" \
                        --create-bucket-configuration LocationConstraint="$BUCKET_REGION"
                fi

                # Enable versioning
                aws s3api put-bucket-versioning --bucket "$BUCKET_NAME" \
                    --versioning-configuration Status=Enabled

                # Enable encryption
                aws s3api put-bucket-encryption --bucket "$BUCKET_NAME" \
                    --server-side-encryption-configuration \
                    '{"Rules": [{"ApplyServerSideEncryptionByDefault": {"SSEAlgorithm": "AES256"}}]}'

                # Block public access
                aws s3api put-public-access-block --bucket "$BUCKET_NAME" \
                    --public-access-block-configuration \
                    "BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true"

                echo "✓ State bucket created and configured"
            else
                echo "✓ State bucket already exists"
            fi

            # Unset assumed role credentials
            unset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN
        }

        # Set Terraform backend configuration variables (stored in TARGET account)
        export TF_STATE_BUCKET="terraform-state-${TARGET_ACCOUNT_ID}"
        export TF_STATE_KEY="regional-cluster/${TARGET_ALIAS}.tfstate"
        export TF_STATE_REGION=$TARGET_REGION
        export TF_STATE_ASSUME_ROLE_ARN="arn:aws:iam::${TARGET_ACCOUNT_ID}:role/OrganizationAccountAccessRole"

        # Ensure state bucket exists in target account
        ensure_state_bucket "$TF_STATE_BUCKET" "$TF_STATE_REGION" "$TARGET_ACCOUNT_ID"

        echo "Using Terraform state (stored in regional account):"
        echo "  Bucket: $TF_STATE_BUCKET"
        echo "  Key: $TF_STATE_KEY"
        echo "  Region: $TF_STATE_REGION"

        # Regional cluster is deployed to TARGET_ACCOUNT_ID (regional account)
        echo "Deploying regional cluster to account: ${TARGET_ACCOUNT_ID}"
        echo "  Region: ${TARGET_REGION}"
        echo "  Alias: ${TARGET_ALIAS}"

        # Assume role for secret cleanup and Terraform operations
        ROLE_ARN="arn:aws:iam::${TARGET_ACCOUNT_ID}:role/OrganizationAccountAccessRole"
        echo "Assuming role for cross-account access to ${TARGET_ACCOUNT_ID}..."
        echo "Role ARN: ${ROLE_ARN}"
        if ! CREDS=$(aws sts assume-role --role-arn "${ROLE_ARN}" --role-session-name "cleanup-secrets" --output json 2>&1); then
            echo "❌ Failed to assume role: ${ROLE_ARN}"
            echo "AWS CLI error output:"
            echo "$CREDS"
            exit 1
        fi

        # Validate credentials were returned
        if ! echo "$CREDS" | jq -e '.Credentials' >/dev/null 2>&1; then
            echo "❌ Role assumption succeeded but credentials not found in response"
            echo "Role ARN: ${ROLE_ARN}"
            echo "Response:"
            echo "$CREDS"
            exit 1
        fi

        REGIONAL_ACCESS_KEY=$(echo "$CREDS" | jq -r '.Credentials.AccessKeyId')
        REGIONAL_SECRET_KEY=$(echo "$CREDS" | jq -r '.Credentials.SecretAccessKey')
        REGIONAL_SESSION_TOKEN=$(echo "$CREDS" | jq -r '.Credentials.SessionToken')

        # Final validation that credentials are not null/empty
        if [[ -z "$REGIONAL_ACCESS_KEY" || "$REGIONAL_ACCESS_KEY" == "null" ]]; then
            echo "❌ Failed to extract valid credentials from assume-role response"
            exit 1
        fi

        echo "✓ Successfully assumed role and extracted credentials"

        # Export credentials for Terraform backend access
        export AWS_ACCESS_KEY_ID=$REGIONAL_ACCESS_KEY
        export AWS_SECRET_ACCESS_KEY=$REGIONAL_SECRET_KEY
        export AWS_SESSION_TOKEN=$REGIONAL_SESSION_TOKEN

        # Force delete any secrets that are scheduled for deletion
        for SECRET_NAME in "maestro/server-cert" "maestro/server-config" "maestro/db-credentials"; do
            if aws secretsmanager describe-secret --secret-id "$SECRET_NAME" --region "${TARGET_REGION}" 2>/dev/null | \
               jq -e '.DeletedDate != null' >/dev/null 2>&1; then
                echo "Force deleting pending secret: $SECRET_NAME"
                aws secretsmanager delete-secret \
                    --secret-id "$SECRET_NAME" \
                    --force-delete-without-recovery \
                    --region "${TARGET_REGION}" || echo "Could not delete $SECRET_NAME (may not exist)"
            fi
        done
        echo "Secret cleanup complete"

        # Set Terraform variables for regional cluster
        export TF_VAR_app_code="${APP_CODE}"
        export TF_VAR_service_phase="${SERVICE_PHASE}"
        export TF_VAR_cost_center="${COST_CENTER}"
        export TF_VAR_repository_url="${CODEBUILD_SOURCE_REPO_URL:-https://github.com/placeholder/repo.git}"
        export TF_VAR_repository_branch="${CODEBUILD_SOURCE_VERSION:-main}"
        export TF_VAR_api_additional_allowed_accounts="${TARGET_ACCOUNT_ID}"

        echo "Terraform variables:"
        echo "  App Code: $TF_VAR_app_code"
        echo "  Service Phase: $TF_VAR_service_phase"
        echo "  Cost Center: $TF_VAR_cost_center"
        echo "  Repository URL: $TF_VAR_repository_url"
        echo "  Repository Branch: $TF_VAR_repository_branch"
        echo "  API Additional Allowed Accounts: $TF_VAR_api_additional_allowed_accounts (regional account)"
      - make pipeline-provision-regional-infra
      - echo "Regional cluster infrastructure provisioned successfully."
      - unset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN

  post_build:
    commands:
      - echo "Infrastructure deployment complete."
      - |
        if [ -f terraform/config/regional-cluster/outputs.json ]; then
          echo "=== Terraform Outputs ==="
          cat terraform/config/regional-cluster/outputs.json
        fi

artifacts:
  files:
    - '**/*'
    - terraform/config/regional-cluster/outputs.json
