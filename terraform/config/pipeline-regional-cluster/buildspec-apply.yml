version: 0.2

env:
  shell: bash

phases:
  install:
    commands:
      - ./scripts/pipeline-common/terraform-install.sh

  pre_build:
    commands:
      - source scripts/pipeline-common/setup-apply-preflight.sh
      - |
        # Regional cluster uses Terraform provider assume_role for cross-account access
        if [ "$TARGET_ACCOUNT_ID" != "$CENTRAL_ACCOUNT_ID" ]; then
            echo "✅ Terraform will assume OrganizationAccountAccessRole in account $TARGET_ACCOUNT_ID"
        else
            echo "✅ Deploying to central account - no role assumption needed"
        fi
        echo ""

  build:
    commands:
      - echo "=========================================="
      - echo "Provisioning Regional Cluster Infrastructure"
      - echo "=========================================="
      - |
        set -euo pipefail

        echo "Deploying to account: ${TARGET_ACCOUNT_ID}"
        echo "  Region: ${TARGET_REGION}"
        echo "  Alias: ${TARGET_ALIAS}"
        echo ""

        # Configure Terraform backend (state in central account, region detected in pre_build)
        export TF_STATE_BUCKET="terraform-state-${CENTRAL_ACCOUNT_ID}"
        export TF_STATE_KEY="regional-cluster/${TARGET_ALIAS}.tfstate"

        echo "Terraform backend:"
        echo "  Bucket: $TF_STATE_BUCKET (central account: $CENTRAL_ACCOUNT_ID)"
        echo "  Key: $TF_STATE_KEY"
        echo "  Region: $TF_STATE_REGION"
        echo ""

        # Set Terraform variables
        export TF_VAR_region="${TARGET_REGION}"
        export TF_VAR_app_code="${APP_CODE}"
        export TF_VAR_service_phase="${SERVICE_PHASE}"
        export TF_VAR_cost_center="${COST_CENTER}"

        # Set repository URL and branch with proper fallback handling for set -u
        # Note: CODEBUILD_SOURCE_VERSION contains S3 artifact location, not git branch
        # Use REPOSITORY_BRANCH (from CodeBuild env vars) or GITHUB_BRANCH instead
        _REPO_URL="${REPOSITORY_URL:-}"
        _REPO_BRANCH="${REPOSITORY_BRANCH:-${GITHUB_BRANCH:-main}}"
        export TF_VAR_repository_url="${REPOSITORY_URL:-https://github.com/${GITHUB_REPOSITORY}.git}"
        export TF_VAR_repository_branch="${_REPO_BRANCH}"

        export TF_VAR_api_additional_allowed_accounts="${TARGET_ACCOUNT_ID}"

        # Set enable_bastion variable (default to false if not set)
        ENABLE_BASTION="${ENABLE_BASTION:-false}"
        if [ "$ENABLE_BASTION" == "true" ] || [ "$ENABLE_BASTION" == "1" ]; then
            export TF_VAR_enable_bastion="true"
        else
            export TF_VAR_enable_bastion="false"
        fi

        echo "Terraform variables:"
        echo "  Region: $TF_VAR_region"
        echo "  Target Account: $TF_VAR_target_account_id (Terraform will assume role if cross-account)"
        echo "  Target Alias: $TF_VAR_target_alias"
        echo "  App Code: $TF_VAR_app_code"
        echo "  Service Phase: $TF_VAR_service_phase"
        echo "  Cost Center: $TF_VAR_cost_center"
        echo "  Repository URL: $TF_VAR_repository_url"
        echo "  Repository Branch: $TF_VAR_repository_branch"
        echo "  API Additional Allowed Accounts: $TF_VAR_api_additional_allowed_accounts"
        echo "  Enable Bastion: $TF_VAR_enable_bastion"
        echo ""

        # Export required environment variables for Makefile target
        # For regional clusters, extract region_alias from generated terraform config
        export ENVIRONMENT="${ENVIRONMENT:-staging}"
        RC_CONFIG_FILE="deploy/${ENVIRONMENT}/${TARGET_REGION}/terraform/regional.json"
        if [ ! -f "$RC_CONFIG_FILE" ]; then
            echo "❌ ERROR: Regional cluster config not found: $RC_CONFIG_FILE"
            echo "   This file should be generated by scripts/render.py"
            exit 1
        fi

        export REGION_ALIAS=$(jq -r '.region_alias' "$RC_CONFIG_FILE")
        echo "Extracted REGION_ALIAS from config: $REGION_ALIAS"

        # Run provisioning (in same shell to preserve exports)
        if [ "${IS_DESTROY:-false}" == "true" ]; then
            echo "⚠️ DESTRUCTION MODE ENABLED"
            make pipeline-destroy-regional
            echo "✅ Regional cluster destroyed successfully."
        else
            make pipeline-provision-regional
            echo "✅ Regional cluster provisioned successfully."
        fi

  post_build:
    commands:
      - echo "Infrastructure deployment complete."
artifacts:
  files:
    - '**/*'
    - terraform/config/regional-cluster/outputs.json
